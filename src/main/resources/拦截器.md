



#### 拦截器的使用

##### org.apache.ibatis.plugin.Interceptor
```
  // 拦截方法
  Object intercept(Invocation invocation) throws Throwable;

  // 拦截器带来对象
  // InterceptorChain#pluginAll()
  // Plugin#wrap(Object target, Interceptor interceptor)
  Object plugin(Object target);

  // 设置属性  
  void setProperties(Properties properties);
```

##### 1) 实现拦截器接口

##### 2) 在mybatis-config.xml中配置插件 



#### 拦截器调用过程 

##### 1) org.apache.ibatis.session.SqlSessionFactoryBuilder#build(Reader reader)
   通过SqlSessionFactoryBuilder解析配置中的插件, 委托给XMLConfigBuilder#pluginElement(XNode parent)解析配置,
   然后通过Configuration#addInterceptor()添加进配置中
   
   
##### 2) SqlSessionFactory#调用
```
  public ParameterHandler newParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) {
    ParameterHandler parameterHandler = mappedStatement.getLang().createParameterHandler(mappedStatement, parameterObject, boundSql);
    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler);
    return parameterHandler;
  }

  public ResultSetHandler newResultSetHandler(Executor executor, MappedStatement mappedStatement, RowBounds rowBounds, ParameterHandler parameterHandler,
      ResultHandler resultHandler, BoundSql boundSql) {
    ResultSetHandler resultSetHandler = new DefaultResultSetHandler(executor, mappedStatement, parameterHandler, resultHandler, boundSql, rowBounds);
    resultSetHandler = (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);
    return resultSetHandler;
  }

  public StatementHandler newStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) {
    StatementHandler statementHandler = new RoutingStatementHandler(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);
    // 在这里为statementHandler添加了对应的插件处理链
    // 使用拦截器链的拦截器生成对应的代理对象
    // 可以层层调用
    statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);
    return statementHandler;
  }
```












