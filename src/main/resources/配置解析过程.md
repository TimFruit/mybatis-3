

#### 配置解析过程

   org.apache.ibatis.session.SqlSessionFactoryBuilder#build()
   
   以上是mybatis的入口
   首先解析mybatis-config.xml配置文件  
   SqlSessionFactoryBuilder#build()方法最后委托给XMLConfigBuilder解析


##### builder模块用于解析配置 

###### XMLConfigBuilder解析各模块

```
private void parseConfiguration(XNode root) {

    // 解析配置过程, 代码写的有点像spring中的某个方法,
    // 分出多个配置元素的解析方法

    try {
      //issue #117 read properties first
      propertiesElement(root.evalNode("properties"));

      // settings
      Properties settings = settingsAsProperties(root.evalNode("settings"));

      // 加载虚拟文件系统, 加载资源, io 
      loadCustomVfs(settings);
      // 加载日志实现
      loadCustomLogImpl(settings);

      // 类型别名
      typeAliasesElement(root.evalNode("typeAliases"));
      // 插件
      pluginElement(root.evalNode("plugins"));
      // 对象工厂
      objectFactoryElement(root.evalNode("objectFactory"));
      // 对象包装工厂
      objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));
      // 反射器工厂
      reflectorFactoryElement(root.evalNode("reflectorFactory"));


      // ------------------------
      // 设置Configuration中的属性,
      // settings, typeAliases, plugins, objectFactory, objectWrapperFactory, reflectorFactory 对应Configuration中的属性
      settingsElement(settings);



      // read it after objectFactory and objectWrapperFactory issue #631
      // 环境配置, 事务管理, 数据源 
      environmentsElement(root.evalNode("environments"));
      // 数据库id, 用于绑定不同的sql语句
      databaseIdProviderElement(root.evalNode("databaseIdProvider"));


      // 类型处理器
      typeHandlerElement(root.evalNode("typeHandlers"));

      // 重点
      // mappers配置路径
      mapperElement(root.evalNode("mappers"));
    } catch (Exception e) {
      throw new BuilderException("Error parsing SQL Mapper Configuration. Cause: " + e, e);
    }
  }
```




#####  XMLConfigBuilder#mapperElement(root.evalNode("mappers"))  

对配置文件中的<mappers/>元素进行加载 == > 存放在Configuration#mappedStatements


```
// 加载mapper
  // =============================================
  // mybatis加载Mapper的总入口
  // 1. 通过配置包查找对应的Mapper接口添加， mapper.xml配置文件应在同一个包下
  // 2. 通过配置resource= "mapper.xml" 路径来加载 
  // =============================================
  private void mapperElement(XNode parent) throws Exception {  // mappers
    if (parent != null) {
      for (XNode child : parent.getChildren()) {

        if ("package".equals(child.getName())) { // 1. 可以指定 "包" 级别
          String mapperPackage = child.getStringAttribute("name");
          // 会加载包名下的所有类, 并使用注解构建器解析, 先解析mapper.xml配置文件, 后再解析mapper.class
            // 如何指定额外包下的配置文件???
            // 只能通过指定xml配置文件来查找, 如果指定类, 则对应的配置文件需要放在和类同一个包下, 或者classpath路径下
          configuration.addMappers(mapperPackage);

        } else {
            // 单个指定
            // resource, url 指定对应的xml文件, class指定对应的类
            // 委托给XMLMapperBuilder解析
          String resource = child.getStringAttribute("resource");
          String url = child.getStringAttribute("url");
          String mapperClass = child.getStringAttribute("class");
          if (resource != null && url == null && mapperClass == null) {
            ErrorContext.instance().resource(resource);
            InputStream inputStream = Resources.getResourceAsStream(resource);
            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());
            mapperParser.parse();
          } else if (resource == null && url != null && mapperClass == null) {
            ErrorContext.instance().resource(url);
            InputStream inputStream = Resources.getUrlAsStream(url);
            XMLMapperBuilder mapperParser = new XMLMapperBuilder(inputStream, configuration, url, configuration.getSqlFragments());
            mapperParser.parse();
          } else if (resource == null && url == null && mapperClass != null) {
            Class<?> mapperInterface = Resources.classForName(mapperClass);
            configuration.addMapper(mapperInterface);
          } else {
            throw new BuilderException("A mapper element may only specify a url, resource or class, but not more than one.");
          }
        }
      }
    }
  }
```


XMLMapperBuilder#parse():

```
  /**
   * 主要方法, parse
   */
  public void parse() {
    if (!configuration.isResourceLoaded(resource)) {
      // 加载解析mapper.xml中各个元素， 包括解析statement
      configurationElement(parser.evalNode("/mapper"));
      // 设置已加载解析的资源
      configuration.addLoadedResource(resource);
      // 加载解析对应的mapper接口, 将接口放到mapper注册表中  
      bindMapperForNamespace();
    }

    // 加载解析尚未加载完的数据
    parsePendingResultMaps();
    parsePendingCacheRefs();
    parsePendingStatements();
  }
```



#####  Configuration#getMappedStatement(statement)

```
  public MappedStatement getMappedStatement(String id) {
    return this.getMappedStatement(id, true);
  }
```

```
public MappedStatement getMappedStatement(String id, boolean validateIncompleteStatements) {
    if (validateIncompleteStatements) {
      buildAllStatements();
    }
    return mappedStatements.get(id);
  }
```











